# 교재 순서 변경 기능 설정 가이드

## 📋 개요
같은 카테고리 내에서 교재의 표시 순서를 드래그 앤 드롭으로 변경할 수 있는 기능입니다.

---

## 🔧 1단계: Supabase 마이그레이션 실행

### 1.1 Supabase SQL Editor 접속
1. [Supabase 대시보드](https://supabase.com/dashboard) 접속
2. 프로젝트 선택
3. 왼쪽 메뉴에서 **SQL Editor** 클릭

### 1.2 마이그레이션 SQL 실행
아래 SQL을 복사하여 **SQL Editor**에 붙여넣고 **RUN** 클릭:

```sql
-- textbooks 테이블에 display_order 컬럼 추가
ALTER TABLE textbooks 
ADD COLUMN IF NOT EXISTS display_order INTEGER DEFAULT 0;

-- 기존 데이터에 display_order 설정 (카테고리별로 순서 부여)
WITH ranked_textbooks AS (
  SELECT 
    id,
    ROW_NUMBER() OVER (PARTITION BY category_id ORDER BY name) as rn
  FROM textbooks
)
UPDATE textbooks 
SET display_order = ranked_textbooks.rn
FROM ranked_textbooks
WHERE textbooks.id = ranked_textbooks.id;

-- 인덱스 추가 (카테고리별 정렬 성능 향상)
CREATE INDEX IF NOT EXISTS idx_textbooks_category_order 
ON textbooks(category_id, display_order);

-- 코멘트 추가
COMMENT ON COLUMN textbooks.display_order IS '카테고리 내 교재 표시 순서 (작을수록 위에 표시)';
```

### 1.3 성공 확인
- ✅ **Success. No rows returned** 메시지 확인
- ❌ 에러 발생 시: 에러 메시지를 확인하고 다시 시도

---

## 🧪 2단계: 기능 테스트

### 2.1 관리자 페이지 접속
1. 로컬 개발 서버 실행:
   ```bash
   npm run dev
   ```

2. 브라우저에서 접속:
   ```
   http://localhost:3000/admin/login
   ```

3. 비밀번호 입력: `7136`

4. 왼쪽 메뉴에서 **교재 관리** 클릭

### 2.2 같은 카테고리 내 교재 순서 변경
1. 카테고리를 클릭하여 펼치기
2. 교재를 드래그하여 같은 카테고리 내 다른 교재 위로 드롭
3. 교재 순서가 즉시 변경되는지 확인

### 2.3 사용자 페이지 확인
1. 새 탭에서 메인 페이지 열기:
   ```
   http://localhost:3000
   ```

2. 좌측 패널에서 해당 카테고리를 열어 교재 순서 확인
3. 관리자 페이지에서 설정한 순서대로 표시되는지 확인

---

## 🎯 3단계: 사용 방법

### 3.1 교재 순서 변경 (같은 카테고리 내)
- **드래그**: 교재명을 클릭하여 드래그
- **드롭**: 같은 카테고리 내 다른 교재 위에 드롭
- **결과**: 교재 순서가 즉시 변경되고 사용자 페이지에 실시간 반영

### 3.2 교재 이동 (다른 카테고리로)
- **드래그**: 교재명을 클릭하여 드래그
- **드롭**: 다른 카테고리명 위에 드롭 또는 해당 카테고리 내 교재 위에 드롭
- **결과**: 교재가 다른 카테고리로 이동

### 3.3 카테고리 순서 변경
- **드래그**: 카테고리명을 클릭하여 드래그
- **드롭**: 다른 카테고리명 위에 드롭
- **결과**: 카테고리 순서가 즉시 변경

---

## 📊 정렬 우선순위

사용자 페이지에서 교재는 다음 순서로 정렬됩니다:

1. **카테고리 순서** (`categories.display_order`)
2. **카테고리 내 교재 순서** (`textbooks.display_order`)
3. **교재 이름** (알파벳/가나다 순)

**미분류 교재**는 항상 맨 아래에 표시됩니다.

---

## 🔍 트러블슈팅

### 문제 1: 드래그 앤 드롭이 작동하지 않음
**원인**: `display_order` 컬럼이 없음  
**해결**: 1단계 마이그레이션 SQL 다시 실행

### 문제 2: 교재 순서가 변경되지 않음
**원인**: API 오류  
**해결**: 
1. 브라우저 콘솔 확인 (F12)
2. Network 탭에서 `/api/admin/textbooks/reorder` 요청 확인
3. 응답 상태 코드 및 에러 메시지 확인

### 문제 3: 사용자 페이지에 순서 변경이 반영되지 않음
**원인**: Realtime 구독 문제  
**해결**:
1. 브라우저 새로고침 (Ctrl+R)
2. Supabase Realtime이 `textbooks` 테이블에 활성화되어 있는지 확인

---

## ✅ 구현 완료 체크리스트

- [x] `textbooks.display_order` 컬럼 추가
- [x] `/api/admin/textbooks/reorder` API 구현
- [x] 관리자 페이지 드래그 앤 드롭 로직 수정
- [x] 사용자 페이지 정렬 로직에 `display_order` 반영
- [x] 같은 카테고리 내 교재 순서 변경 기능 작동
- [x] 다른 카테고리로 교재 이동 기능 작동
- [x] 사용자 페이지 실시간 반영 확인

---

## 📝 추가 정보

### 관련 파일
- **마이그레이션**: `supabase/migrations/007_add_textbook_display_order.sql`
- **API**: `src/app/api/admin/textbooks/reorder/route.ts`
- **관리자 페이지**: `src/app/admin/textbooks/page.tsx`
- **사용자 페이지 API**: `src/app/api/files/tree/route.ts`

### API 엔드포인트
- **PUT** `/api/admin/textbooks/reorder`
  - **Body**: `{ textbooks: [{ id: string, display_order: number }] }`
  - **Response**: `{ success: boolean, error?: string }`

---

**작성일**: 2025-11-12  
**버전**: 5.9+

