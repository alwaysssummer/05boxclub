# 카테고리 기능 가이드

## 개요
교재를 카테고리별로 그룹화하여 관리할 수 있는 기능입니다. 관리자 페이지에서 드래그 앤 드롭으로 직관적으로 교재를 분류하고, 사용자 페이지에서 카테고리별로 접을 수 있는 깔끔한 UI로 제공됩니다.

## 📋 필수 설정 단계

### 1. 데이터베이스 마이그레이션 실행

**Supabase SQL Editor**에서 다음 SQL을 실행하세요:

```sql
-- 파일: supabase/migrations/005_add_categories.sql

-- 카테고리 테이블 생성
CREATE TABLE IF NOT EXISTS categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  icon TEXT DEFAULT '📚',
  display_order INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- textbooks 테이블에 category_id 컬럼 추가
ALTER TABLE textbooks 
ADD COLUMN IF NOT EXISTS category_id UUID REFERENCES categories(id) ON DELETE SET NULL;

-- 인덱스 추가
CREATE INDEX IF NOT EXISTS idx_textbooks_category_id ON textbooks(category_id);
CREATE INDEX IF NOT EXISTS idx_categories_display_order ON categories(display_order);

-- 기본 카테고리 추가
INSERT INTO categories (name, icon, display_order) VALUES
  ('교과서', '📚', 1),
  ('모의고사', '🗓️', 2),
  ('기타', '📖', 3)
ON CONFLICT DO NOTHING;

-- updated_at 자동 업데이트 트리거
CREATE OR REPLACE FUNCTION update_categories_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_categories_updated_at
  BEFORE UPDATE ON categories
  FOR EACH ROW
  EXECUTE FUNCTION update_categories_updated_at();
```

### 2. Supabase Realtime 활성화

Supabase 대시보드에서:
1. **Database** → **Replication** 메뉴로 이동
2. `categories` 테이블에 대한 Realtime 활성화
3. `textbooks` 테이블에 대한 Realtime도 확인 (이미 활성화되어 있어야 함)

## 🎯 주요 기능

### 관리자 페이지 (`/admin/textbooks`)

#### 1. **드래그 앤 드롭으로 교재 이동**
- 교재 왼쪽의 그립 아이콘(⋮⋮)을 드래그
- 다른 카테고리 영역으로 드롭
- 즉시 데이터베이스에 반영되고 사용자 페이지에 실시간 업데이트

#### 2. **카테고리 관리**
- **카테고리 추가**: "카테고리 추가" 버튼 클릭
  - 이모지와 이름 입력
  - 자동으로 순서 할당
- **카테고리 삭제**: 각 카테고리 헤더의 휴지통 아이콘
  - 삭제 시 해당 교재는 "미분류"로 이동

#### 3. **접기/펼치기**
- 카테고리 헤더를 클릭하여 교재 목록 토글

### 사용자 페이지 (좌측 사이드바)

#### 1. **카테고리별 그룹화**
- 카테고리 헤더: 아이콘 + 이름 + 교재 수
- 접기/펼치기 가능
- display_order 순으로 정렬

#### 2. **실시간 반영**
- 관리자가 교재를 이동하면 즉시 반영
- 카테고리가 추가/삭제되면 즉시 반영

## 🔄 실시간 동기화

### Realtime 구독 테이블
- `files` - 파일 변경
- `textbooks` - 교재 변경 (카테고리 이동 포함)
- `categories` - 카테고리 추가/수정/삭제

### 동작 방식
1. 관리자가 교재를 드래그 앤 드롭
2. API (`/api/admin/textbooks/move`) 호출하여 DB 업데이트
3. Supabase Realtime이 변경 감지
4. 모든 클라이언트(사용자 페이지)에 브로드캐스트
5. 각 클라이언트가 자동으로 데이터 새로고침

## 📁 파일 구조

### 새로 생성된 파일
```
supabase/migrations/
  ├── 005_add_categories.sql         # DB 마이그레이션

src/app/api/admin/
  ├── categories/
  │   └── route.ts                    # 카테고리 CRUD API
  └── textbooks/
      └── move/
          └── route.ts                # 교재 이동 API

src/app/admin/
  └── textbooks/
      └── page.tsx                    # 관리자 교재 관리 UI (드래그 앤 드롭)

docs/
  └── 카테고리_기능_가이드.md         # 이 파일
```

### 수정된 파일
```
src/app/api/files/tree/route.ts       # 카테고리 정보 포함
src/components/LeftSidebar.tsx        # 카테고리별 UI 추가
package.json                          # @dnd-kit 라이브러리 추가
```

## 🎨 UI/UX 특징

### 관리자 페이지
- **직관적 드래그 앤 드롭**
  - 시각적 피드백 (드래그 중 반투명)
  - 드래그 오버레이로 이동 중인 교재 표시
- **사용자 페이지와 동일한 구조**
  - 관리자가 사용자 화면을 직접 보면서 편집 가능
- **실시간 교재 수 표시**
  - 각 카테고리에 속한 교재 수를 배지로 표시

### 사용자 페이지
- **깔끔한 카테고리 섹션**
  - 시각적 구분선 (border-bottom)
  - 아이콘으로 카테고리 구분
  - 접기/펼치기로 공간 절약
- **자연스러운 애니메이션**
  - 부드러운 토글 전환
  - 호버 효과

## 🚀 사용 시나리오

### 시나리오 1: 새 교재 분류
1. 관리자 페이지에서 "미분류" 카테고리 확인
2. 새로 동기화된 교재를 적절한 카테고리로 드래그
3. 사용자 페이지에서 즉시 확인 가능

### 시나리오 2: 카테고리 추가
1. "카테고리 추가" 버튼 클릭
2. 이모지와 이름 입력 (예: 🎯 "기출문제")
3. 교재를 새 카테고리로 이동
4. 사용자 페이지에 새 카테고리 자동 표시

### 시나리오 3: 카테고리 정리
1. 불필요한 카테고리 삭제
2. 해당 교재는 자동으로 "미분류"로 이동
3. 미분류 교재를 다른 카테고리로 재분류

## ⚠️ 주의사항

1. **카테고리 삭제 시**
   - 해당 카테고리의 모든 교재는 "미분류"로 이동
   - 데이터가 삭제되지는 않음

2. **순서 변경**
   - display_order는 자동으로 관리됨
   - 향후 드래그 앤 드롭으로 순서 변경 기능 추가 예정

3. **Realtime 요구사항**
   - Supabase Realtime이 활성화되어 있어야 함
   - 활성화하지 않으면 수동 새로고침 필요

## 🔧 API 엔드포인트

### 카테고리 관리
- `GET /api/admin/categories` - 카테고리 목록 조회
- `POST /api/admin/categories` - 카테고리 생성
- `PUT /api/admin/categories` - 카테고리 수정
- `DELETE /api/admin/categories?id={id}` - 카테고리 삭제

### 교재 이동
- `PUT /api/admin/textbooks/move` - 단일 교재 이동
  ```json
  {
    "textbook_id": "uuid",
    "category_id": "uuid" // null이면 미분류
  }
  ```
- `POST /api/admin/textbooks/move` - 여러 교재 일괄 이동
  ```json
  {
    "textbook_ids": ["uuid1", "uuid2"],
    "category_id": "uuid"
  }
  ```

### 파일 트리
- `GET /api/files/tree` - 카테고리 정보 포함한 교재 트리

## ✅ 완료 체크리스트

- [ ] Supabase 마이그레이션 실행
- [ ] Supabase Realtime 활성화 (`categories`, `textbooks`)
- [ ] 관리자 페이지에서 드래그 앤 드롭 테스트
- [ ] 사용자 페이지에서 카테고리별 그룹화 확인
- [ ] 실시간 동기화 확인 (관리자 변경 → 사용자 자동 반영)
- [ ] 카테고리 추가/삭제 테스트

## 🎉 완료!

카테고리 기능이 성공적으로 구현되었습니다! 이제 교재를 체계적으로 관리하고 사용자에게 깔끔한 UI를 제공할 수 있습니다.

