# 교재 요청 5회 제한 기능 가이드

## 📋 개요

같은 컴퓨터(같은 IP 주소)에서 **24시간 내 최대 5회**까지 교재를 추천할 수 있도록 제한하는 기능입니다.

---

## 🎯 주요 기능

### 1. **24시간 내 5회 제한**
- 같은 IP에서 같은 교재에 대해 24시간 내 5회까지만 추천 가능
- 5회 초과 시 "24시간 내 최대 5회까지만 추천할 수 있습니다" 메시지 표시

### 2. **남은 횟수 표시**
- 추천 성공 시 "24시간 내 남은 추천 횟수: X회" 알림 표시
- 실시간으로 남은 횟수 확인 가능

### 3. **IP 기반 추적**
- 익명화된 IP 주소로 사용자 식별
- 예: `192.168.1.100` → `192.168.1.xxx`
- 개인정보 보호하면서도 중복 방지 가능

---

## 🗄️ 데이터베이스 구조

### `textbook_request_logs` 테이블

```sql
CREATE TABLE textbook_request_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  textbook_name TEXT NOT NULL,
  user_ip TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

| 컬럼 | 타입 | 설명 |
|------|------|------|
| `id` | UUID | 로그 고유 ID |
| `textbook_name` | TEXT | 요청한 교재명 |
| `user_ip` | TEXT | 요청자 IP (익명화) |
| `created_at` | TIMESTAMPTZ | 요청 시각 |

---

## 📊 시나리오 예시

### 시나리오 1: 정상 추천
```
사용자 A (IP: 123.456.789.xxx)
→ "빠바구문독해" 추천 (1회) ✅ 남은 횟수: 4회
→ "빠바구문독해" 추천 (2회) ✅ 남은 횟수: 3회
→ "빠바구문독해" 추천 (3회) ✅ 남은 횟수: 2회
→ "빠바구문독해" 추천 (4회) ✅ 남은 횟수: 1회
→ "빠바구문독해" 추천 (5회) ✅ 남은 횟수: 0회
→ "빠바구문독해" 추천 (6회) ❌ 제한 초과
```

### 시나리오 2: 다른 교재
```
사용자 A (IP: 123.456.789.xxx)
→ "빠바구문독해" 5회 추천 ✅
→ "더상승유형독해" 5회 추천 ✅ (다른 교재이므로 별도 카운트)
```

### 시나리오 3: 24시간 후 초기화
```
사용자 A (IP: 123.456.789.xxx)
→ "빠바구문독해" 5회 추천 ✅
→ 24시간 경과
→ "빠바구문독해" 추천 ✅ (다시 5회 가능)
```

---

## 🔧 설정 방법

### 1. 마이그레이션 실행

Supabase SQL Editor에서 다음 SQL 실행:

```sql
-- 006_add_request_logs.sql 파일 내용 복사하여 실행
```

또는 Supabase CLI 사용:

```bash
supabase db push
```

### 2. 환경 변수 확인

`.env.local` 파일에 Supabase 설정이 올바른지 확인:

```env
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
```

### 3. 서버 재시작

```bash
npm run dev
```

---

## 🧹 로그 정리 (선택사항)

24시간 이상 된 로그를 자동으로 삭제하려면 Supabase에서 cron job 설정:

```sql
-- Supabase Dashboard > Database > Functions > Create Function
SELECT delete_old_request_logs();
```

또는 수동 삭제:

```sql
DELETE FROM textbook_request_logs
WHERE created_at < NOW() - INTERVAL '24 hours';
```

---

## 🎨 사용자 경험

### 추천 성공 시
```
✅ 요청이 등록되었습니다!
24시간 내 남은 추천 횟수: 4회
```

### 제한 초과 시
```
❌ 24시간 내 최대 5회까지만 추천할 수 있습니다.
나중에 다시 시도해주세요.
```

---

## 🔍 디버깅

### 로그 확인

```sql
-- 특정 IP의 24시간 내 요청 확인
SELECT * FROM textbook_request_logs
WHERE user_ip = '123.456.789.xxx'
AND created_at >= NOW() - INTERVAL '24 hours'
ORDER BY created_at DESC;

-- 특정 교재의 요청 로그 확인
SELECT * FROM textbook_request_logs
WHERE textbook_name = '빠바구문독해'
AND created_at >= NOW() - INTERVAL '24 hours'
ORDER BY created_at DESC;
```

### API 테스트

```bash
# 요청 테스트
curl -X POST http://localhost:3000/api/requests \
  -H "Content-Type: application/json" \
  -d '{"textbookName":"빠바구문독해"}'
```

---

## 📝 참고사항

1. **IP 기반 제한의 한계**
   - VPN 사용 시 우회 가능
   - 같은 네트워크의 여러 사용자가 제한 공유

2. **24시간 계산**
   - 첫 요청 시각부터 24시간 (rolling window)
   - 예: 오후 3시에 요청 → 다음날 오후 3시 이후 초기화

3. **로그 보관**
   - 24시간 이상 된 로그는 정기적으로 삭제 권장
   - 스토리지 절약 및 성능 향상

---

## 🚀 향후 개선 사항

- [ ] 사용자 계정 기반 제한 (로그인 시)
- [ ] 관리자 페이지에서 제한 횟수 조정 기능
- [ ] 실시간 남은 횟수 표시 (UI에 항상 표시)
- [ ] 제한 초과 사용자 통계 대시보드

